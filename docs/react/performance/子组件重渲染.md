---
id: reactPerformanceManyTimesRender
title: reactå­ç»„ä»¶é‡æ¸²æŸ“é—®é¢˜
hide_title: true
sidebar_label: å­ç»„ä»¶é‡æ¸²æŸ“é—®é¢˜
---

## react é»˜è®¤æ¸²æŸ“è¡Œä¸º

`react` çš„æ¯æ¬¡è§¦å‘é¡µé¢æ›´æ–°å®é™…ä¸Šåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

- `render` : ä¸»è¦è´Ÿè´£è¿›è¡Œ `vdom` çš„ `diff` è®¡ç®—
- `commit phase`: ä¸»è¦è´Ÿè´£å°† `vdom diff` çš„ç»“æœæ›´æ–°åˆ°å®é™…çš„ `DOM` ä¸Š

:::warning reactæ¸²æŸ“å¾ˆé‡è¦çš„ä¸€ä¸ªç‰¹æ€§
å½“çˆ¶ç»„ä»¶é‡æ¸²æŸ“çš„æ—¶å€™ï¼Œå…¶ä¼šé»˜è®¤é€’å½’çš„é‡æ¸²æŸ“æ‰€æœ‰å­ç»„ä»¶

```jsx
export default function Parent() {
  const [text, setText] = useState<number>(0)

  function clickEvent() {
    setText(text + 1)
  }
  return (
    <>
      <div onClick={clickEvent}>æŒ‰é’® {text}</div>
      <Child />
    </>
  )
}

function Child() {
  return <div>å­å…ƒç´ </div>
}
```

å¦‚ğŸ‘†ä¸ºä¾‹ï¼Œè™½ç„¶ `Child` ç»„ä»¶æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œä½†æ˜¯ç”±äº `Parent` ç»„ä»¶é‡æ¸²æŸ“ï¼Œ`å¸¦åŠ¨äº†Childçš„é‡æ¸²æŸ“`ã€‚
:::

## ä¼˜åŒ–

è¿™é‡Œæ˜¯ä¸€ä¸ªå…·æœ‰ä¸¥é‡æ¸²æŸ“æ€§èƒ½é—®é¢˜çš„ç»„ä»¶

```jsx
import { useState } from 'react';

export default function App() {
  let [color, setColor] = useState('red');
  return (
    <div>
      <input value={color} onChange={(e) => setColor(e.target.value)} />
      <p style={{ color }}>Hello, world!</p>
      <ExpensiveTree />
    </div>
  );
}

function ExpensiveTree() {
  let now = performance.now();
  while (performance.now() - now < 100) {
    // Artificial delay -- do nothing for 100ms
  }
  return <p>I am a very slow component tree.</p>;
}
```

é—®é¢˜å°±æ˜¯å½“ `App` ä¸­çš„ `color` å˜åŒ–æ—¶ï¼Œæˆ‘ä»¬ä¼šé‡æ–°æ¸²æŸ“ä¸€æ¬¡è¢«æˆ‘ä»¬æ‰‹åŠ¨å¤§å¹…å»¶ç¼“æ¸²æŸ“çš„ `<ExpensiveTree />` ç»„ä»¶ã€‚

### 1. æ‹†åˆ†ç»„ä»¶ï¼Œç§»åŠ¨ state

å¦‚æœä½ ä»”ç»†çœ‹ä¸€ä¸‹æ¸²æŸ“ä»£ç ï¼Œä½ ä¼šæ³¨æ„åˆ°è¿”å›çš„æ ‘ä¸­åªæœ‰ä¸€éƒ¨åˆ†çœŸæ­£å…³å¿ƒå½“å‰çš„ `state: color`ï¼š

```jsx {5,6}
export default function App() {
  let [color, setColor] = useState('red');
  return (
    <div>
      <input value={color} onChange={(e) => setColor(e.target.value)} />
      <p style={{ color }}>Hello, world!</p>
      <ExpensiveTree />
    </div>
  );
}
```

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠéœ€è¦è¿™ä¸ª `state: color` çš„å…ƒç´ å•ç‹¬æ‹åˆ°ä¸€ä¸ªç»„ä»¶ `Form` ä¸­ï¼Œè®©ä»–ä»¬æˆåŠŸå…„å¼Ÿç»„ä»¶ï¼Œè€Œä¸æ˜¯åŒ…è£¹çš„å½¢å¼ã€‚

```jsx {4}
export default function App() {
  return (
    <>
      <Form />
      <ExpensiveTree />
    </>
  );
}

function Form() {
  let [color, setColor] = useState('red');
  return (
    <>
      <input value={color} onChange={(e) => setColor(e.target.value)} />
      <p style={{ color }}>Hello, world!</p>
    </>
  );
}
```

### 2. å†…å®¹æå‡ï¼Œé€šè¿‡ children ä¼ é€’

å¦‚æœè¿™ä¸ªçŠ¶æ€åœ¨ä¸Šå±‚ä»£ç ä¸­ï¼Œä¸Šè¿°çš„æ–¹æ³•å°±ä¸å¯è¡Œäº†ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬å°† `color` æ”¾åˆ°çˆ¶å…ƒç´  `div` ä¸­ã€‚

```jsx {4}
export default function App() {
  let [color, setColor] = useState('red');
  return (
    <div style={{ color }}>
      <input value={color} onChange={(e) => setColor(e.target.value)} />
      <p>Hello, world!</p>
      <ExpensiveTree />
    </div>
  );
}
```

æˆ‘ä»¬å¯ä»¥å°†å†…å®¹æå‡ `<ExpensiveTree />ç»„ä»¶ä»¥prop`çš„å½¢å¼ä¼ å…¥ï¼ŒçŠ¶æ€å˜åŒ–çš„æ—¶å€™ç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯ç»„ä»¶ä¾ç„¶ä¿å­˜è¿™ä¸Šä¸€æ¬¡çš„ `children`ï¼Œæ‰€ä»¥ `React` å¹¶ä¸ä¼šè®¿é—®é‚£æ£µå­æ ‘ã€‚ å› æ­¤ï¼Œ`ExpensiveTree` ä¸ä¼šé‡æ–°æ¸²æŸ“ã€‚

```jsx {4-5,16}
export default function App() {
  return (
    <ColorPicker>
      <p>Hello, world!</p>
      <ExpensiveTree />
    </ColorPicker>
  );
}

function ColorPicker({ children }) {
  let [color, setColor] = useState("red");

  return (
    <div style={{ color }}>
      <input value={color} onChange={(e) => setColor(e.target.value)} />
      {children}
    </div>
  );
}
```

### 3. ç¼“å­˜ç»„ä»¶

`React` ä¸ºäº†å¸®åŠ©è§£å†³å­ç»„ä»¶é‡æ¸²æŸ“æ€§èƒ½é—®é¢˜ï¼Œå®é™…ä¸Šæä¾›äº†ä¸‰ä¸ªAPIç”¨äºæ€§èƒ½ä¼˜åŒ–

- `class shouldComponentUpdateç”Ÿå‘½å‘¨æœŸ`ï¼šå¦‚æœåœ¨è¿™ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œè¿”å› `false`ï¼Œå°±å¯ä»¥è·³è¿‡åç»­è¯¥ç»„ä»¶çš„ `render` è¿‡ç¨‹
- `React.PureComponent`ï¼šä¼šå¯¹ä¼ å…¥ç»„ä»¶çš„ `props` è¿›è¡Œæµ…æ¯”è¾ƒï¼Œå¦‚æœæµ…æ¯”è¾ƒç›¸ç­‰ï¼Œåˆ™è·³è¿‡ `render` è¿‡ç¨‹ï¼Œ`é€‚ç”¨äºClass Component`
- `React.memo`ï¼šåŒä¸Šï¼Œé€‚ç”¨äº `functional Component`

#### å› ä¸ºç¼“å­˜ç»„ä»¶æ˜¯é€šè¿‡ `æµ…æ¯”è¾ƒ` æ¥åˆ¤æ–­å‘ç”Ÿå˜åŒ–çš„ï¼Œæ‰€ä»¥å­˜åœ¨è¿™ä¹ˆå‡ ä¸ªé—®é¢˜ï¼š

- å¯¹è±¡ `å€¼ä¸å˜` çš„æƒ…å†µä¸‹, å¯¹è±¡å¼•ç”¨å˜åŒ–ä¼šå¯¼è‡´ `React` ç»„ä»¶çš„ç¼“å­˜å¤±æ•ˆï¼Œè¿›è€Œå¯¼è‡´æ€§èƒ½é—®é¢˜

  ```jsx {8}
  export default function Parent() {
    const [text, setText] = useState<number>(0)

    function clickEvent() {
      setText(text + 1)
    }

    const item = { text: 'ä¸å˜' }
    return (
      <>
        <div onClick={clickEvent}>æŒ‰é’® {text}</div>
        <Child item={item} />
      </>
    )
  }

  const Child = React.memo(({ item }) => <div>{item.text}</div>)
  ```

  :::warning
  å› ä¸ºå‡½æ•°å¼ç»„ä»¶çš„åŸç†ï¼Œå¯¼è‡´æ¯ä¸€æ¬¡æ¸²æŸ“çš„ `item` éƒ½æ˜¯é‡æ–°ç”Ÿæˆçš„ï¼Œæ‰€ä»¥æ¯æ¬¡ä¼ é€’ç»™ `<Child />` ç»„ä»¶çš„ `itemå¼•ç”¨` å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯¼è‡´ç¼“å­˜æ— æ•ˆï¼Œæ¯æ¬¡éƒ½æ¸²æŸ“ã€‚
  :::

- å¯¹è±¡ `å€¼å˜åŒ–` çš„çš„æƒ…å†µä¸‹ï¼Œå¯¹è±¡å¼•ç”¨ä¸å˜ä¼šå¯¼è‡´çš„ `React` ç»„ä»¶çš„ `UI` å’Œæ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚

  ```jsx {1,6,11}
  const item = { text: 1 }
  export default function Parent() {
    const [text, setText] = useState<number>(0)

    function clickEvent() {
      setText(text + 1)
      item.text += 1
    }
    return (
      <>
        <div onClick={clickEvent}>æŒ‰é’® {text}</div>
        <Child item={item} />
      </>
    )
  }

  const Child = React.memo(({ item }) => <div>{item.text}</div>)
  ```

  :::warning
  å› ä¸ºæ˜¯æµ…æ¯”è¾ƒï¼Œæ‰€ä»¥å½“ `item.text` å€¼å˜åŒ–çš„æ—¶å€™ï¼Œç»„ä»¶å¹¶ä¸ä¼šé‡æ–°æ¸²æŸ“ã€‚
  :::

## å‚è€ƒ

- [åœ¨ä½ å†™memo()ä¹‹å‰](https://overreacted.io/zh-hans/before-you-memo/)
- [React Hooks(å››): immutable](https://www.zhihu.com/column/p/163590288)
